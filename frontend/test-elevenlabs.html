<!DOCTYPE html>
<html>
<head>
    <title>ElevenLabs WebSocket Test</title>
</head>
<body>
    <h1>ElevenLabs Direct Test</h1>
    <button id="start">Start Conversation</button>
    <button id="stop" disabled>Stop</button>
    <div id="status">Status: Idle</div>
    <div id="logs" style="margin-top: 20px; font-family: monospace; font-size: 12px;"></div>

    <script>
        let ws = null;
        let mediaRecorder = null;
        let audioContext = null;
        let mediaStream = null;

        const API_KEY = 'sk_390728398bd0c50652fcd314b726854fd5f9475e252953f4';
        const AGENT_ID = 'Nnwf6EF9RgYOj6c1a9VU';

        function log(msg) {
            const logs = document.getElementById('logs');
            const time = new Date().toLocaleTimeString();
            logs.innerHTML = `[${time}] ${msg}<br>` + logs.innerHTML;
            console.log(msg);
        }

        function setStatus(msg) {
            document.getElementById('status').textContent = 'Status: ' + msg;
            log(msg);
        }

        async function getSignedUrl() {
            const response = await fetch(
                `https://api.elevenlabs.io/v1/convai/conversation/get-signed-url?agent_id=${AGENT_ID}`,
                {
                    headers: { 'xi-api-key': API_KEY }
                }
            );
            const data = await response.json();
            log('Got signed URL: ' + data.signed_url);
            return data.signed_url;
        }

        async function startConversation() {
            try {
                setStatus('Getting signed URL...');
                const signedUrl = await getSignedUrl();

                setStatus('Connecting WebSocket...');
                ws = new WebSocket(signedUrl);

                ws.onopen = async () => {
                    setStatus('WebSocket CONNECTED');

                    // Send initiation
                    log('Sending conversation_initiation_client_data');
                    ws.send(JSON.stringify({
                        type: 'conversation_initiation_client_data'
                    }));

                    // Start microphone
                    setStatus('Requesting microphone...');
                    mediaStream = await navigator.mediaDevices.getUserMedia({
                        audio: {
                            sampleRate: 16000,
                            channelCount: 1,
                            echoCancellation: true,
                            noiseSuppression: true
                        }
                    });
                    log('Microphone access granted');

                    // Use MediaRecorder with webm
                    mediaRecorder = new MediaRecorder(mediaStream, {
                        mimeType: 'audio/webm;codecs=opus'
                    });

                    mediaRecorder.ondataavailable = async (event) => {
                        if (ws.readyState === WebSocket.OPEN && event.data.size > 0) {
                            const buffer = await event.data.arrayBuffer();
                            const base64 = btoa(String.fromCharCode(...new Uint8Array(buffer)));
                            ws.send(JSON.stringify({ user_audio_chunk: base64 }));
                            log('Sent audio chunk: ' + event.data.size + ' bytes');
                        }
                    };

                    mediaRecorder.start(100); // 100ms chunks
                    setStatus('Recording and sending audio');
                    document.getElementById('start').disabled = true;
                    document.getElementById('stop').disabled = false;
                };

                ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        log('Received: ' + data.type);

                        if (data.type === 'ping') {
                            ws.send(JSON.stringify({
                                type: 'pong',
                                event_id: data.ping_event.event_id
                            }));
                            log('Sent pong');
                        } else if (data.type === 'user_transcript') {
                            log('USER SAID: ' + data.user_transcription_event.user_transcript);
                        } else if (data.type === 'agent_response') {
                            log('AGENT SAID: ' + data.agent_response_event.agent_response);
                        } else if (data.type === 'audio') {
                            log('Received audio chunk');
                            const audio = new Audio('data:audio/mpeg;base64,' + data.audio_event.audio_base_64);
                            audio.play().catch(e => log('Audio play error: ' + e.message));
                        } else {
                            log('Other event: ' + JSON.stringify(data).substring(0, 100));
                        }
                    } catch (e) {
                        log('Parse error: ' + e.message);
                    }
                };

                ws.onerror = (error) => {
                    log('WebSocket ERROR: ' + error);
                    setStatus('ERROR');
                };

                ws.onclose = (event) => {
                    log('WebSocket CLOSED: ' + event.code + ' ' + event.reason);
                    setStatus('Disconnected');
                    stopConversation();
                };

            } catch (error) {
                log('ERROR: ' + error.message);
                setStatus('Error: ' + error.message);
            }
        }

        function stopConversation() {
            if (mediaRecorder) {
                mediaRecorder.stop();
                mediaRecorder = null;
            }
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }
            if (ws) {
                ws.close();
                ws = null;
            }
            document.getElementById('start').disabled = false;
            document.getElementById('stop').disabled = true;
            setStatus('Stopped');
        }

        document.getElementById('start').onclick = startConversation;
        document.getElementById('stop').onclick = stopConversation;
    </script>
</body>
</html>
